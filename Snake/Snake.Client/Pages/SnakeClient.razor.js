var framecount = 0;
var animationFrameId = 0;
var animating = false;

export function ToggleAnimation(on) {
    console.log("N: Toggle Animation " + on);

    animating = on;
    if (on) {
        window.requestAnimationFrame(AnimationLoopJS);
    }
    else {
        window.cancelAnimationFrame(animationFrameId);
    }

}

/**
 * This code tells the C# side to draw the scene.
 * It then "sleeps" and recalls itself X frames a second
 * where X is usually 60, or whatever the browser is optimized
 * for.  
 * 
 * Additionally, it only calls this method if the windows is
 * showing. If you switch to a different tab, the animation stops.
 * 
 * @param {any} timeStamp
 */
export function AnimationLoopJS(timeStamp) {
    framecount++;
    DotNetSide.invokeMethodAsync('Draw', timeStamp);
    if (animating)
    {
        animationFrameId = window.requestAnimationFrame(AnimationLoopJS);
    }
    else
    {
        window.cancelAnimationFrame(animationFrameId);
    }
}

/**
 * This is a resize event handler that allows the screen
 * to be resized and gives C# the opportunity to do something
 * about it (if you wish);
 */
function resizeCanvasToFitWindow() {
    var holder = document.getElementById('myCanvas');
    var canvas = holder.querySelector('canvas');
    if (canvas) {
        var sideCar = document.getElementsByClassName('sidebar');
        var main = document.getElementsByTagName('main');

        //var width = window.innerWidth - sideCar[0].getBoundingClientRect().width;
        let width = document.getElementsByTagName('main')[0].offsetWidth;
        width = Math.min(width - 100, 1000);
        canvas.width = width;

        DotNetSide.invokeMethodAsync('ResizeInBlazor', width, width);
    }
}

/**
 * Setup the JavaScript side so:
 * 1) It knows about the C# side --> DotNetSide
 * 2) It has a resize window handler
 * 
 * @param {any} DotNetSide - the C# instance from the razor code.
 */
export function initJS(DotNetSide) {
    window.DotNetSide = DotNetSide;
    window.addEventListener("resize", resizeCanvasToFitWindow);
    resizeCanvasToFitWindow();
}

document.addEventListener('keydown', function (event) {
    // Optionally log the key for testing
    console.log('Key pressed:', event.key);

    // Call the C# method and pass the key pressed
    DotNetSide.invokeMethodAsync('HandleKeyPress', event.key);
});

///**
// * Stop the animation when we leave the page.
// */
//window.addEventListener("unload", () => {
//    window.DotNetSide.invokeMethod('Snake.Client','DisconnectFromServer');
//    console.log("Networked JS: leaving page.");
//    animating = false;
//});

window.addEventListener("beforeunload",
    async function (event) {
        // Set a custom message
        DotNetSide.invokeMethodAsync('DisconnectFromServer');
        animating = false;
        event.preventDefault();
        event.returnValue = 'Are you sure you want to leave?';
        return 'Are you sure you want to leave?';
    });